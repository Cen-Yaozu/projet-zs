<view class="container"><view class="header"><view data-event-opts="{{[['tap',[['navBack',['$event']]]]]}}" class="back-button" bindtap="__e"><text class="iconfont icon-left"></text></view><text class="title">用户管理</text></view><view class="content"><block wx:if="{{hasPermission}}"><view class="filter-bar"><view class="search-box"><text class="iconfont icon-search"></text><input class="input" type="text" placeholder="搜索用户名/姓名/学号" data-event-opts="{{[['input',[['__set_model',['','searchKeyword','$event',[]]]]]]}}" value="{{searchKeyword}}" bindinput="__e"/><block wx:if="{{searchKeyword}}"><text data-event-opts="{{[['tap',[['e0',['$event']]]]]}}" class="clear-icon iconfont icon-close" bindtap="__e"></text></block></view><button data-event-opts="{{[['tap',[['showAddModal',['$event']]]]]}}" class="add-button" bindtap="__e"><text class="add-icon iconfont icon-add"></text><text>新增用户</text></button></view></block><block wx:if="{{!hasPermission}}"><view class="permission-denied"><view class="permission-icon"><text class="iconfont icon-lock"></text></view><view class="permission-text"><view class="permission-title">暂无访问权限</view><view class="permission-desc">您当前账号无权访问用户管理功能</view></view><button data-event-opts="{{[['tap',[['navToHome',['$event']]]]]}}" class="back-home-btn" bindtap="__e">返回首页</button></view></block><block wx:if="{{hasPermission}}"><view class="user-list"><block wx:if="{{$root.g0}}"><view class="empty-tip"><text class="empty-icon iconfont icon-empty"></text><view>暂无用户数据</view></view></block><block wx:if="{{!loading&&loadError&&errorCode!==403}}"><view class="empty-tip"><text class="empty-icon iconfont icon-warning"></text><view>加载失败，请重试</view></view></block><block wx:for="{{$root.l0}}" wx:for-item="item" wx:for-index="__i0__" wx:key="id"><view class="user-item"><view class="user-info"><view class="avatar-box"><image class="avatar" src="{{item.$orig.avatar||'/static/images/default-avatar.png'}}" mode="aspectFill"></image><view class="{{['role-tag',roleClassMap[item.$orig.role]||'']}}">{{item.m0}}</view></view><view class="user-detail"><view class="user-name-row"><text class="user-name">{{item.$orig.name||item.$orig.username}}</text><view class="{{['status-tag',item.$orig.status?'active':'inactive']}}">{{''+(item.$orig.status?'已激活':'未激活')+''}}</view></view><view class="user-meta"><block wx:if="{{item.$orig.username}}"><view class="meta-item"><text class="meta-icon iconfont icon-user"></text><text>{{item.$orig.username}}</text></view></block><block wx:if="{{item.$orig.studentId}}"><view class="meta-item"><text class="meta-icon iconfont icon-id"></text><text>{{item.$orig.studentId}}</text></view></block><block wx:if="{{item.$orig.email}}"><view class="meta-item"><text class="meta-icon iconfont icon-email"></text><text>{{item.$orig.email}}</text></view></block><block wx:if="{{item.$orig.department}}"><view class="meta-item"><text class="meta-icon iconfont icon-department"></text><text>{{item.$orig.department}}</text></view></block></view></view></view><view class="action-row"><button data-event-opts="{{[['tap',[['handleEdit',['$0'],[[['users','id',item.$orig.id]]]]]]]}}" class="action-button edit-btn" bindtap="__e">编辑</button><button data-event-opts="{{[['tap',[['handleResetPassword',['$0'],[[['users','id',item.$orig.id]]]]]]]}}" class="action-button reset-btn" bindtap="__e">重置密码</button><button data-event-opts="{{[['tap',[['handleToggleStatus',['$0'],[[['users','id',item.$orig.id]]]]]]]}}" class="{{['action-button','toggle-btn',item.$orig.status?'disable-btn':'enable-btn']}}" bindtap="__e">{{item.$orig.status?'禁用':'启用'}}</button><button data-event-opts="{{[['tap',[['handleDelete',['$0'],[[['users','id',item.$orig.id]]]]]]]}}" class="action-button delete-btn" bindtap="__e">删除</button></view></view></block></view></block><block wx:if="{{$root.g1}}"><view class="pagination"><button data-event-opts="{{[['tap',[['handlePageChange',[currentPage-1]]]]]}}" class="{{['page-btn','prev-btn',(currentPage===1)?'disabled':'']}}" bindtap="__e">上一页</button><block wx:for="{{$root.l1}}" wx:for-item="page" wx:for-index="__i1__" wx:key="*this"><button data-event-opts="{{[['tap',[['e1',['$event']]]]]}}" data-event-params="{{({page})}}" class="{{['page-btn',(page===currentPage)?'active':'']}}" bindtap="__e">{{page}}</button></block><button data-event-opts="{{[['tap',[['handlePageChange',[currentPage+1]]]]]}}" class="{{['page-btn','next-btn',(currentPage===totalPages)?'disabled':'']}}" bindtap="__e">下一页</button><text class="page-text">{{"共 "+total+" 条"}}</text></view></block></view><block wx:if="{{loading}}"><view class="loading-overlay"><view class="loading-content"><text class="loading-text">加载中...</text></view></view></block><block wx:if="{{hasPermission}}"><uni-popup class="vue-ref" vue-id="dbf1efc2-1" type="center" data-ref="popup" bind:__l="__l" vue-slots="{{['default']}}"><view class="popup-content"><view class="popup-header"><text class="popup-title">{{isEdit?'编辑用户':'新增用户'}}</text></view><view class="popup-body"><view class="form-item"><text class="label">用户名<text class="required">*</text></text><input class="input" type="text" placeholder="请输入用户名" disabled="{{isEdit}}" data-event-opts="{{[['input',[['__set_model',['$0','username','$event',[]],['form']]]]]}}" value="{{form.username}}" bindinput="__e"/></view><block wx:if="{{!isEdit}}"><view class="form-item"><text class="label">密码<text class="required">*</text></text><input class="input" type="password" placeholder="请输入密码" data-event-opts="{{[['input',[['__set_model',['$0','password','$event',[]],['form']]]]]}}" value="{{form.password}}" bindinput="__e"/></view></block><view class="form-item"><text class="label">姓名</text><input class="input" type="text" placeholder="请输入姓名" data-event-opts="{{[['input',[['__set_model',['$0','name','$event',[]],['form']]]]]}}" value="{{form.name}}" bindinput="__e"/></view><view class="form-item"><text class="label">学号</text><input class="input" type="text" placeholder="请输入学号" data-event-opts="{{[['input',[['__set_model',['$0','studentId','$event',[]],['form']]]]]}}" value="{{form.studentId}}" bindinput="__e"/></view><view class="form-item"><text class="label">邮箱</text><input class="input" type="text" placeholder="请输入邮箱" data-event-opts="{{[['input',[['__set_model',['$0','email','$event',[]],['form']]]]]}}" value="{{form.email}}" bindinput="__e"/></view><view class="form-item"><text class="label">角色<text class="required">*</text></text><picker range="{{roleOptions}}" value="{{roleIndex}}" data-event-opts="{{[['change',[['handleRoleChange',['$event']]]]]}}" bindchange="__e"><view class="picker-value">{{''+roleOptions[roleIndex]+''}}<text class="iconfont icon-down"></text></view></picker></view><view class="form-item"><text class="label">院系</text><input class="input" type="text" placeholder="请输入院系" data-event-opts="{{[['input',[['__set_model',['$0','department','$event',[]],['form']]]]]}}" value="{{form.department}}" bindinput="__e"/></view></view><view class="popup-footer"><button data-event-opts="{{[['tap',[['hidePopup',['$event']]]]]}}" class="cancel-btn" bindtap="__e">取消</button><button data-event-opts="{{[['tap',[['handleSubmit',['$event']]]]]}}" class="confirm-btn" bindtap="__e">确定</button></view></view></uni-popup></block></view>